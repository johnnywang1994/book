import{_ as s,c as a,d as e,o as p}from"./app-E1s5qOOn.js";const t={};function o(l,n){return p(),a("div",null,[...n[0]||(n[0]=[e(`<h1 id="safari-indexeddb-blob-克隆問題解析與修復方案" tabindex="-1"><a class="header-anchor" href="#safari-indexeddb-blob-克隆問題解析與修復方案"><span>Safari IndexedDB Blob 克隆問題解析與修復方案</span></a></h1><p>在開發使用 IndexedDB 儲存包含 Blob 對象的數據時，Safari 瀏覽器可能會遇到 <code>DataCloneError</code> 或 <code>parse_error</code> 錯誤。這篇文章將深入解析這個問題的根本原因，並說明為什麼我們的修復方案能夠解決這個問題。</p><h2 id="問題背景" tabindex="-1"><a class="header-anchor" href="#問題背景"><span>問題背景</span></a></h2><p>我們在一個專案中使用 IndexedDB 來存儲圖片數據，這些圖片以 Blob 對象的形式存在。當我們嘗試更新已存在的圖片數據時，在 Safari 瀏覽器中會遇到錯誤，而在 Chrome 等其他瀏覽器中則沒有問題。</p><h2 id="根本原因分析" tabindex="-1"><a class="header-anchor" href="#根本原因分析"><span>根本原因分析</span></a></h2><p>問題的根本原因是 <strong>Safari 的 IndexedDB 結構化克隆（Structured Clone）機制與 Blob 對象的交互問題</strong>。</p><h3 id="原本的問題" tabindex="-1"><a class="header-anchor" href="#原本的問題"><span>原本的問題</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token comment">// 原本的代碼</span></span>
<span class="line"><span class="token keyword">async</span> <span class="token function">updateImage</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> updates<span class="token operator">:</span> Partial<span class="token operator">&lt;</span>Omit<span class="token operator">&lt;</span>NailImage<span class="token punctuation">,</span> <span class="token string">&#39;id&#39;</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">const</span> existingImage <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;images&#39;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// ← 問題開始</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>existingImage<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> updatedImage <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>existingImage<span class="token punctuation">,</span> <span class="token operator">...</span>updates <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token comment">// ← 問題惡化</span></span>
<span class="line">    <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&#39;images&#39;</span><span class="token punctuation">,</span> updatedImage<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// ← 錯誤發生</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="為什麼會失敗" tabindex="-1"><a class="header-anchor" href="#為什麼會失敗"><span>為什麼會失敗？</span></a></h3><ol><li><strong>第一次讀取</strong>：<code>db.get()</code> 從 IndexedDB 讀取時，Safari 會對整個對象進行<strong>結構化克隆</strong></li><li><strong>展開運算符</strong>：<code>{ ...existingImage, ...updates }</code> 又創建了一個新對象，觸發了<strong>第二次克隆</strong></li><li><strong>Blob 引用失效</strong>：Safari 在多次克隆含有 Blob 的對象時，Blob 的內部引用可能被破壞</li><li><strong>寫入失敗</strong>：<code>db.put()</code> 嘗試寫入時，發現 Blob 已經無效，拋出 <code>DataCloneError</code> 或 <code>parse_error</code></li></ol><h3 id="修復方案的原理" tabindex="-1"><a class="header-anchor" href="#修復方案的原理"><span>修復方案的原理</span></a></h3><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token comment">// 修復後的代碼</span></span>
<span class="line"><span class="token keyword">async</span> <span class="token function">updateImage</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> updates<span class="token operator">:</span> Partial<span class="token operator">&lt;</span>Omit<span class="token operator">&lt;</span>NailImage<span class="token punctuation">,</span> <span class="token string">&#39;id&#39;</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  </span>
<span class="line">  <span class="token comment">// ✅ 使用單個事務</span></span>
<span class="line">  <span class="token keyword">const</span> tx <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token string">&#39;images&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;readwrite&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">const</span> store <span class="token operator">=</span> tx<span class="token punctuation">.</span><span class="token function">objectStore</span><span class="token punctuation">(</span><span class="token string">&#39;images&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  </span>
<span class="line">  <span class="token keyword">const</span> existingImage <span class="token operator">=</span> <span class="token keyword">await</span> store<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>existingImage<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> updatedImage <span class="token operator">=</span> <span class="token punctuation">{</span> </span>
<span class="line">      <span class="token operator">...</span>existingImage<span class="token punctuation">,</span> </span>
<span class="line">      <span class="token operator">...</span>updates<span class="token punctuation">,</span></span>
<span class="line">      <span class="token comment">// ✅ 關鍵：明確保留原始 Blob 引用</span></span>
<span class="line">      imageBlob<span class="token operator">:</span> updates<span class="token punctuation">.</span>imageBlob <span class="token operator">||</span> existingImage<span class="token punctuation">.</span>imageBlob</span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">await</span> store<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>updatedImage<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  </span>
<span class="line">  <span class="token keyword">await</span> tx<span class="token punctuation">.</span>done<span class="token punctuation">;</span>  <span class="token comment">// ✅ 確保事務完成</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="為什麼這樣就修好了" tabindex="-1"><a class="header-anchor" href="#為什麼這樣就修好了"><span>為什麼這樣就修好了？</span></a></h3><ol><li><p><strong>單事務操作</strong>：</p><ul><li>在同一個事務（transaction）中完成 <code>get</code> 和 <code>put</code></li><li>Safari 的 IndexedDB 在單個事務內對 Blob 的處理更可靠</li><li>避免了跨事務的 Blob 引用失效問題</li></ul></li><li><p><strong>明確的 Blob 引用保留</strong>：</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line">imageBlob<span class="token operator">:</span> updates<span class="token punctuation">.</span>imageBlob <span class="token operator">||</span> existingImage<span class="token punctuation">.</span>imageBlob</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>明確告訴 JavaScript：使用原始的 Blob 引用</li><li>而不是讓展開運算符隱式複製它</li><li>Safari 的垃圾回收機制不會誤認為舊 Blob 可以被回收</li></ul></li><li><p><strong>await tx.done</strong>：</p><ul><li>確保事務完全提交後才結束</li><li>防止事務被提前中止導致 Blob 引用失效</li></ul></li></ol><h3 id="為什麼-chrome-沒問題" tabindex="-1"><a class="header-anchor" href="#為什麼-chrome-沒問題"><span>為什麼 Chrome 沒問題？</span></a></h3><ul><li><strong>Chrome/V8</strong> 的 IndexedDB 實現對 Blob 的引用管理更寬鬆</li><li><strong>Safari/WebKit</strong> 更嚴格遵守規範，對結構化克隆中的 Blob 處理更保守</li><li>Chrome 可以容忍多次克隆，Safari 不行</li></ul><h3 id="類比說明" tabindex="-1"><a class="header-anchor" href="#類比說明"><span>類比說明</span></a></h3><p>想像 Blob 是一個<strong>銀行保險箱的鑰匙</strong>：</p><ul><li><strong>Chrome</strong>：複印鑰匙很寬鬆，多複印幾次沒關係</li><li><strong>Safari</strong>：複印鑰匙很嚴格，複印多次後原鑰匙會失效（安全考量）</li></ul><p>這修復就像是：<strong>直接傳遞原始鑰匙，而不是複印後再複印</strong>。</p><h2 id="總結" tabindex="-1"><a class="header-anchor" href="#總結"><span>總結</span></a></h2><p>這個 bug 是 Safari 特有的，因為它對 IndexedDB 中包含 Blob 的對象進行結構化克隆時更加嚴格。修復的核心是：</p><p>✅ 使用單個事務完成讀寫<br> ✅ 明確保留 Blob 的原始引用<br> ✅ 避免隱式的多次克隆</p><p>這是一個很經典的<strong>瀏覽器兼容性問題</strong>，也說明了為什麼前端開發需要在多個瀏覽器上測試！</p>`,24)])])}const c=s(t,[["render",o]]),r=JSON.parse('{"path":"/articles/memo/js/safari-indexeddb-blob-clone-issue.html","title":"Safari IndexedDB Blob 克隆問題解析與修復方案","lang":"zh-TW","frontmatter":{},"git":{"updatedTime":1765477126000,"contributors":[{"name":"JohnnyWang","username":"JohnnyWang","email":"johnny29621189@kimo.com","commits":1,"url":"https://github.com/JohnnyWang"}],"changelog":[{"hash":"587c6f8408526817fdfd7dcaff387faeaf39a542","time":1765477126000,"email":"johnny29621189@kimo.com","author":"JohnnyWang","message":"UPD: update projects"}]},"filePathRelative":"articles/memo/js/safari-indexeddb-blob-clone-issue.md"}');export{c as comp,r as data};
