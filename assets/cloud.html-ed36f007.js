import{_ as p,r as o,o as c,c as i,d as n,e as s,a as t,f as e}from"./app-1a1ac012.js";const l={},u=n("h1",{id:"parse-cloud-code-章節",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#parse-cloud-code-章節","aria-hidden":"true"},"#"),s(" Parse Cloud Code 章節")],-1),r={href:"https://docs.parseplatform.org/cloudcode/guide/",target:"_blank",rel:"noopener noreferrer"},d=n("p",null,[s("預設來說，Parse Cloud 環境入口為 "),n("code",null,"./cloud/main.js"),s("，路徑可以透過 parse server options 設定")],-1),k=n("h2",{id:"cloud-functions",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#cloud-functions","aria-hidden":"true"},"#"),s(" Cloud Functions")],-1),v={href:"https://docs.parseplatform.org/cloudcode/guide/#cloud-functions",target:"_blank",rel:"noopener noreferrer"},m=n("code",null,"Parse.Cloud.define",-1),b=e(`<h3 id="創建-cloud-code-function" tabindex="-1"><a class="header-anchor" href="#創建-cloud-code-function" aria-hidden="true">#</a> 創建 Cloud Code Function</h3><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>Parse<span class="token punctuation">.</span>Cloud<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&#39;averageStars&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> query <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parse<span class="token punctuation">.</span>Query</span><span class="token punctuation">(</span><span class="token string">&#39;Review&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  query<span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token string">&#39;movie&#39;</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>params<span class="token punctuation">.</span>movie<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> results <span class="token operator">=</span> <span class="token keyword">await</span> query<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> results<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sum <span class="token operator">+=</span> results<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;stars&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> sum <span class="token operator">/</span> results<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="執行-cloud-code-function" tabindex="-1"><a class="header-anchor" href="#執行-cloud-code-function" aria-hidden="true">#</a> 執行 Cloud Code Function</h3><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> params <span class="token operator">=</span>  <span class="token punctuation">{</span> <span class="token literal-property property">movie</span><span class="token operator">:</span> <span class="token string">&quot;The Matrix&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ratings <span class="token operator">=</span> <span class="token keyword">await</span> Parse<span class="token punctuation">.</span>Cloud<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token string">&quot;averageStars&quot;</span><span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="request-物件" tabindex="-1"><a class="header-anchor" href="#request-物件" aria-hidden="true">#</a> Request 物件</h3><ul><li>params: 傳進 function 的參數</li><li>user: 當前調用的 User</li><li>master: 是否透過 <code>masterKey</code> 調用</li></ul><h3 id="限制條件" tabindex="-1"><a class="header-anchor" href="#限制條件" aria-hidden="true">#</a> 限制條件</h3><p>限制傳入參數必須有 movie，並且只有登入用戶能調用此 function</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>Parse<span class="token punctuation">.</span>Cloud<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;averageStars&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...same above</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
  <span class="token literal-property property">fields</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;movie&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">requireUser</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Parse<span class="token punctuation">.</span>Cloud<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&quot;averageStars&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> query <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parse<span class="token punctuation">.</span>Query</span><span class="token punctuation">(</span><span class="token string">&quot;Review&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  query<span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token string">&quot;movie&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>params<span class="token punctuation">.</span>movie<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> results <span class="token operator">=</span> <span class="token keyword">await</span> query<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">return</span> sum <span class="token operator">/</span> results<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
  <span class="token literal-property property">fields</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">movie</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> String<span class="token punctuation">,</span>
      <span class="token function-variable function">options</span><span class="token operator">:</span> <span class="token parameter">val</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> val<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token string">&quot;Movie must be less than 20 characters&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">requireUserKeys</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">accType</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token string">&#39;reviewer&#39;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token string">&#39;Only reviewers can get average stars&#39;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="常見-options" tabindex="-1"><a class="header-anchor" href="#常見-options" aria-hidden="true">#</a> 常見 options</h4>`,10),h={href:"https://docs.parseplatform.org/cloudcode/guide/#implementing-cloud-function-validation",target:"_blank",rel:"noopener noreferrer"},g=n("li",null,"requireMaster",-1),f=n("li",null,"requireUser",-1),y=n("li",null,"validateMasterKey",-1),q=n("li",null,"fields",-1),w=n("li",null,"requireAnyUserRoles",-1),_=n("li",null,"requireAllUserRoles",-1),j=n("li",null,"requireUserKeys",-1),x={href:"https://docs.parseplatform.org/cloudcode/guide/#more-advanced-validation",target:"_blank",rel:"noopener noreferrer"},C=e(`<h4 id="validation-函數檢驗" tabindex="-1"><a class="header-anchor" href="#validation-函數檢驗" aria-hidden="true">#</a> Validation 函數檢驗</h4><p>當一般 options 無法滿足你的檢驗需求時，你可以傳入一個 function 對其進行更詳細的檢驗，也提升檢驗邏輯的複用能力</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">validationRules</span> <span class="token operator">=</span> <span class="token parameter">request</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>master<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>request<span class="token punctuation">.</span>user <span class="token operator">||</span> request<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id <span class="token operator">!==</span> <span class="token string">&#39;masterUser&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token string">&#39;Unauthorized&#39;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

Parse<span class="token punctuation">.</span>Cloud<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&#39;adminFunction&#39;</span><span class="token punctuation">,</span> <span class="token parameter">request</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// do admin code here, confident that request.user.id is masterUser, or masterKey is provided</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> validationRules<span class="token punctuation">)</span>

Parse<span class="token punctuation">.</span>Cloud<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&#39;adminFunctionTwo&#39;</span><span class="token punctuation">,</span> <span class="token parameter">request</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// do admin code here, confident that request.user.id is masterUser, or masterKey is provided</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> validationRules<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>validation 函數會在 Cloud Code Function 前執行，可以使用 async 或 promise 型態的檢驗函數，但盡量確保檢驗過程的簡短，讓 Cloud Code Function 能更快被執行</li></ul><h2 id="cloud-jobs" tabindex="-1"><a class="header-anchor" href="#cloud-jobs" aria-hidden="true">#</a> Cloud Jobs</h2>`,5),P={href:"https://docs.parseplatform.org/cloudcode/guide/#cloud-jobs",target:"_blank",rel:"noopener noreferrer"},S=e(`<p>有時您想執行長時間運行的函數，並且不想等待回應。Cloud Jobs 就是為此而生的。</p><h3 id="創建-job" tabindex="-1"><a class="header-anchor" href="#創建-job" aria-hidden="true">#</a> 創建 Job</h3><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>Parse<span class="token punctuation">.</span>Cloud<span class="token punctuation">.</span><span class="token function">job</span><span class="token punctuation">(</span><span class="token string">&quot;myJob&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>  <span class="token punctuation">{</span>
  <span class="token comment">// params: 傳入參數</span>
  <span class="token comment">// headers: 觸發 job 的請求 headers</span>
  <span class="token comment">// log: 傳入 request 的 logger</span>
  <span class="token comment">// message: 更新 job 狀態的函數</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> params<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> log<span class="token punctuation">,</span> message <span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">;</span>
  <span class="token function">message</span><span class="token punctuation">(</span><span class="token string">&quot;I just started&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">doSomethingVeryLong</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="執行-job" tabindex="-1"><a class="header-anchor" href="#執行-job" aria-hidden="true">#</a> 執行 Job</h3><p>執行 Job 必須以 <code>master</code> 權限進行，注意 url 結構是以綁定的 parse server 位置中的</p><ul><li><code>/[parse-mount-path]/jobs/[job-name]</code></li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-X</span> POST <span class="token parameter variable">-H</span> <span class="token string">&#39;X-Parse-Application-Id: appId&#39;</span> <span class="token parameter variable">-H</span> <span class="token string">&#39;X-Parse-Master-Key: masterKey&#39;</span> https://my-parse-server.com/parse/jobs/myJob
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="查看-job" tabindex="-1"><a class="header-anchor" href="#查看-job" aria-hidden="true">#</a> 查看 Job</h3><p>在 Parse Dashboard 中能夠查看，或是使用 <code>masterKey</code> 對 <code>_JobStatus</code> class 進行 query</p><h2 id="save-triggers" tabindex="-1"><a class="header-anchor" href="#save-triggers" aria-hidden="true">#</a> Save Triggers</h2>`,10),F={href:"https://docs.parseplatform.org/cloudcode/guide/#save-triggers",target:"_blank",rel:"noopener noreferrer"},K=n("code",null,"save triggers",-1),T=e(`<h3 id="validation" tabindex="-1"><a class="header-anchor" href="#validation" aria-hidden="true">#</a> validation</h3><p>以下範例在寫入評價前檢查 <code>stars</code> 數量是否 valid</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>Parse<span class="token punctuation">.</span>Cloud<span class="token punctuation">.</span><span class="token function">beforeSave</span><span class="token punctuation">(</span><span class="token string">&#39;Review&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">fields</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">stars</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">required</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token function-variable function">options</span><span class="token operator">:</span> <span class="token parameter">stars</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> stars <span class="token operator">&gt;=</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> stars <span class="token operator">=</span><span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token string">&#39;Your review must be between one and five stars&#39;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果函數拋出異常，Review 對象將不會被保存，客戶端會報錯。如果沒有拋出任何東西，對象將被正常保存。</p><h3 id="modifying" tabindex="-1"><a class="header-anchor" href="#modifying" aria-hidden="true">#</a> modifying</h3><p>或是在資料儲存寫入前進行修改，以下範例確保存入的 <code>comment</code> 欄位長度在 140 字元內</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>Parse<span class="token punctuation">.</span>Cloud<span class="token punctuation">.</span><span class="token function">beforeSave</span><span class="token punctuation">(</span><span class="token string">&quot;Review&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// original: 保存物件原本的值，若為新物件則為不存在</span>
  <span class="token comment">// object: 即將保存的物件</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> object<span class="token punctuation">,</span> original <span class="token punctuation">}</span> <span class="token operator">=</span> request
  <span class="token keyword">const</span> comment <span class="token operator">=</span> object<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;comment&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>comment<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">140</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Truncate and add a ...</span>
    object<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span> comment<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">137</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="predefined-class" tabindex="-1"><a class="header-anchor" href="#predefined-class" aria-hidden="true">#</a> predefined class</h3><p>對於 Parse 預定義的內建 class，請直接傳入 <code>Parse.User</code> 這種方式，而不是字串</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>Parse<span class="token punctuation">.</span>Cloud<span class="token punctuation">.</span><span class="token function">beforeSave</span><span class="token punctuation">(</span>Parse<span class="token punctuation">.</span>User<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// code here</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// Validation Object or Validation Function</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="aftersave" tabindex="-1"><a class="header-anchor" href="#aftersave" aria-hidden="true">#</a> afterSave</h3><p>前面都是在儲存前做事情，我們也可以使用 <code>afterSave</code> 在物件存入後進行操作，通常用於較為<code>冗長的操作</code>，不希望此操作影響到物件儲存的情況下可以考慮使用，例如下面範例在 <code>Comment</code> 物件存入後，對所屬的 <code>Post</code> 物件 comment 欄位加值</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>Parse<span class="token punctuation">.</span>Cloud<span class="token punctuation">.</span><span class="token function">afterSave</span><span class="token punctuation">(</span><span class="token string">&quot;Comment&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> query <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parse<span class="token punctuation">.</span>Query</span><span class="token punctuation">(</span><span class="token string">&quot;Post&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  query<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>object<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;post&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">post</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      post<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token string">&quot;comments&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> post<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Got an error &quot;</span> <span class="token operator">+</span> error<span class="token punctuation">.</span>code <span class="token operator">+</span> <span class="token string">&quot; : &quot;</span> <span class="token operator">+</span> error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>上面的動作實際上在完成前就會先返回使用者，即使在 <code>post.save()</code> 時發生錯誤，用戶也不會被通知，錯誤可以在 Cloud Code Log 中看到，為了在 afterSave 處理程序完成之前回應客戶端，您的處理程序可能不可返回 promise，並且不要使用 async/await。</p></blockquote><h3 id="context" tabindex="-1"><a class="header-anchor" href="#context" aria-hidden="true">#</a> Context</h3><p>context 是一個讓開發者能在不同時機使用的物件空間，context 會從 <code>beforeSave</code> 處理程序傳遞到 <code>afterSave</code> 處理程序。</p><h2 id="delete-triggers" tabindex="-1"><a class="header-anchor" href="#delete-triggers" aria-hidden="true">#</a> Delete Triggers</h2>`,17),M={href:"https://docs.parseplatform.org/cloudcode/guide/#delete-triggers",target:"_blank",rel:"noopener noreferrer"},U=n("code",null,"beforeDelete",-1),R=e(`<h3 id="beforedelete" tabindex="-1"><a class="header-anchor" href="#beforedelete" aria-hidden="true">#</a> beforeDelete</h3><p>以下範例在刪除 <code>Album</code> 物件之前，檢查其中是否還有 photos 存在，當錯誤拋出時，album 將不會被誤刪除</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>Parse<span class="token punctuation">.</span>Cloud<span class="token punctuation">.</span><span class="token function">beforeDelete</span><span class="token punctuation">(</span><span class="token string">&quot;Album&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> object <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> query <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parse<span class="token punctuation">.</span>Query</span><span class="token punctuation">(</span><span class="token string">&quot;Photo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  query<span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token string">&quot;album&quot;</span><span class="token punctuation">,</span> object<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token keyword">await</span> query<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">useMasterKey</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token string">&quot;Can&#39;t delete album if it still has photos.&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="afterdelete" tabindex="-1"><a class="header-anchor" href="#afterdelete" aria-hidden="true">#</a> afterDelete</h3><p>以下範例在刪除 <code>Post</code> 後，需要一次將 post 的 <code>Comment</code> 全部刪除</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>Parse<span class="token punctuation">.</span>Cloud<span class="token punctuation">.</span><span class="token function">afterDelete</span><span class="token punctuation">(</span><span class="token string">&quot;Post&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> object <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> query <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parse<span class="token punctuation">.</span>Query</span><span class="token punctuation">(</span><span class="token string">&quot;Comment&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  query<span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token string">&quot;post&quot;</span><span class="token punctuation">,</span> object<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 這邊不使用 async/await 可以加快回應使用者的時間，此操作不影響使用者後續動作</span>
  query<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>Parse<span class="token punctuation">.</span>Object<span class="token punctuation">.</span>destroyAll<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Error finding related comments &quot;</span> <span class="token operator">+</span> error<span class="token punctuation">.</span>code <span class="token operator">+</span> <span class="token string">&quot;: &quot;</span> <span class="token operator">+</span> error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="find-triggers" tabindex="-1"><a class="header-anchor" href="#find-triggers" aria-hidden="true">#</a> Find Triggers</h2>`,7),L={href:"https://docs.parseplatform.org/cloudcode/guide/#find-triggers",target:"_blank",rel:"noopener noreferrer"},Q=e(`<h3 id="beforefind-or-afterfind" tabindex="-1"><a class="header-anchor" href="#beforefind-or-afterfind" aria-hidden="true">#</a> beforeFind or afterFind</h3><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// Properties available</span>
Parse<span class="token punctuation">.</span>Cloud<span class="token punctuation">.</span><span class="token function">beforeFind</span><span class="token punctuation">(</span><span class="token string">&#39;MyObject&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> query <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span> <span class="token comment">// the Parse.Query</span>
  <span class="token keyword">let</span> user <span class="token operator">=</span> req<span class="token punctuation">.</span>user<span class="token punctuation">;</span> <span class="token comment">// the user</span>
  <span class="token keyword">let</span> triggerName <span class="token operator">=</span> req<span class="token punctuation">.</span>triggerName<span class="token punctuation">;</span> <span class="token comment">// beforeFind</span>
  <span class="token keyword">let</span> isMaster <span class="token operator">=</span> req<span class="token punctuation">.</span>master<span class="token punctuation">;</span> <span class="token comment">// if the query is run with masterKey</span>
  <span class="token keyword">let</span> isCount <span class="token operator">=</span> req<span class="token punctuation">.</span>count<span class="token punctuation">;</span> <span class="token comment">// if the query is a count operation</span>
  <span class="token keyword">let</span> logger <span class="token operator">=</span> req<span class="token punctuation">.</span>log<span class="token punctuation">;</span> <span class="token comment">// the logger</span>
  <span class="token keyword">let</span> installationId <span class="token operator">=</span> req<span class="token punctuation">.</span>installationId<span class="token punctuation">;</span> <span class="token comment">// The installationId</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// Returning a different query</span>
Parse<span class="token punctuation">.</span>Cloud<span class="token punctuation">.</span><span class="token function">beforeFind</span><span class="token punctuation">(</span><span class="token string">&#39;MyObject&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> query <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
  <span class="token keyword">let</span> otherQuery <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parse<span class="token punctuation">.</span>Query</span><span class="token punctuation">(</span><span class="token string">&#39;MyObject&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  otherQuery<span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token string">&#39;key&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;value&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> Parse<span class="token punctuation">.</span>Query<span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> otherQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="security" tabindex="-1"><a class="header-anchor" href="#security" aria-hidden="true">#</a> Security</h2><p>要覆蓋對象和類訪問權限，您可以設置 <code>useMasterKey: true</code> 如果請求接受主密鑰選項，但需要注意，使用 master 權限卉返回物件所有資源，在將其發送到客戶端之前，您可能希望刪除客戶端不應訪問的物件屬性。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>query<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">useMasterKey</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="config" tabindex="-1"><a class="header-anchor" href="#config" aria-hidden="true">#</a> Config</h2><p>默認情況下，Parse Config 參數可以公開讀取，如果參數包含不應向客戶端公開的敏感信息，則可能不希望這樣做</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 藉由添加 requireMasterKey 在 Config 欄位，可以添加 master 權限的 config 設定</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token keyword">await</span> Parse<span class="token punctuation">.</span>Config<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">useMasterKey</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> privateParam <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;privateParam&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,9);function J(I,V){const a=o("ExternalLinkIcon");return c(),i("div",null,[u,n("ul",null,[n("li",null,[n("a",r,[s("Link"),t(a)])])]),d,k,n("ul",null,[n("li",null,[n("a",v,[s("Link"),t(a)]),s(" Cloud Function 定義由 "),m,s(" 處理，因為是在 Parse 環境下，所以可以直接調用 Parse 相關功能，比如下面範例")])]),b,n("ul",null,[n("li",null,[n("a",h,[s("Link"),t(a)])]),g,f,y,q,w,_,j]),n("p",null,[s("更多限制方式可"),n("a",x,[s("參考這邊"),t(a)])]),C,n("ul",null,[n("li",null,[n("a",P,[s("Link"),t(a)])])]),S,n("ul",null,[n("li",null,[n("a",F,[s("Link"),t(a)]),s(" 當我們想對資料格式做些特殊處理時，如果每一次都要單獨寫一遍非常無意義，此時可以使用 "),K,s(" 對資料的寫入前、寫入後做特定的處理")])]),T,n("ul",null,[n("li",null,[n("a",M,[s("Link"),t(a)]),s(" 在刪除物件之前運行自定義 Cloud Code。您可以使用 "),U,s(" 方法執行此操作。")])]),R,n("ul",null,[n("li",null,[n("a",L,[s("Link"),t(a)]),s(" 在某些情況下，可能希望轉換傳入查詢、添加額外或增加默認限制")])]),Q])}const O=p(l,[["render",J],["__file","cloud.html.vue"]]);export{O as default};
